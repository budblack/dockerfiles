worker_processes  1;
events {
  worker_connections  1024;
}

stream {
  upstream gcloud {
      hash $remote_addr consistent;
      server gg.denger.cc:50012;
  }
  server {
      listen 9598;
      proxy_connect_timeout 10s;
      proxy_timeout 10m;
      proxy_pass gcloud;
  }

  # 对接本机上运行的 Workerman
  upstream iolocal9550 {
      hash $remote_addr consistent;
      server 10.80.232.165:9320;
  }
  upstream iolocal9551 {
      hash $remote_addr consistent;
      server 10.80.232.165:9321;
  }
  upstream iolocal9553 {
      hash $remote_addr consistent;
      server 10.80.232.165:9323;
  }
  server {
      listen 9550;
      proxy_connect_timeout 1s;
      proxy_timeout 10m;
      proxy_pass iolocal9550;
  }
  server {
      listen 9551;
      proxy_connect_timeout 1s;
      proxy_timeout 10m;
      proxy_pass iolocal9551;
  }
  server {
      listen 9553;
      proxy_connect_timeout 1s;
      proxy_timeout 10m;
      proxy_pass iolocal9553;
  }

  # 通用REDIS 2018-02-05 14:46:56创建
  upstream redis6379 {
      hash $remote_addr consistent;
      server 10.80.232.165:6379;
  }
  server {
      listen 9530;
      proxy_connect_timeout 1s;
      proxy_timeout 10m;
      proxy_pass redis6379;
  }
}

http {  
  include       mime.types;  
  default_type  application/octet-stream;  
  sendfile        on;  
  keepalive_timeout  65;  
  
# 首页
  server
  {
    listen 80;
    server_name 119.23.173.49 o.ot.budblack.me atech.ltd www.atech.ltd o.bianbiankj.com www.o.bianbiankj.com;
    location / {
      proxy_redirect off;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header Host $http_host;
      proxy_pass http://10.80.232.165:9001;
    }
  }
  
  # yourls
  server
  {
    listen 80;
    server_name url.tool.budblack.me;
    location / {
      add_header Access-Control-Allow-Origin *;
      proxy_redirect off;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header Host $http_host;
      proxy_pass http://10.80.232.165:9043;
    }
  }
  server
  {
    listen 443 ssl;
    server_name url.tool.budblack.me;
    ssl_certificate     /etc/nginx/url.tool.budblack.me.crt;
    ssl_certificate_key /etc/nginx/url.tool.budblack.me.key;
    ssl_protocols       TLSv1 TLSv1.1 TLSv1.2;
    ssl_ciphers         HIGH:!aNULL:!MD5;
    location / {
      add_header Access-Control-Allow-Origin *;
      proxy_redirect off;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header Host $http_host;
      proxy_pass http://10.80.232.165:9043;
    }
  }
  
  # msign前端服务 web页面
  server
  {
    listen 80;
    server_name www.msign.tech msign.alpha.budblack.me;
    location / {
      proxy_redirect off;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header Host $http_host;
      proxy_pass http://10.80.232.165:2021;
    }
  }
  server
  {
    listen 443 ssl;
    server_name msign.alpha.budblack.me;
    ssl_certificate     /etc/nginx/msign.alpha.budblack.me.crt;
    ssl_certificate_key /etc/nginx/msign.alpha.budblack.me.key;
    ssl_protocols       TLSv1 TLSv1.1 TLSv1.2;
    ssl_ciphers         HIGH:!aNULL:!MD5;
    location / {
      proxy_redirect off;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header Host $http_host;
      proxy_pass http://10.80.232.165:2021;
    }
  }
  
  # 网络资源离线下载 2017年11月06日 创建
  server
    {
      listen 80;
      server_name fetch.ot.budblack.me fetch.tool.budblack.me;
      location / {
        proxy_redirect off;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header Host $http_host;
        proxy_pass http://10.80.232.165:9031;
      }
  }
  
  # FRPS 的控制面板, 2017年12月19日12:27:59创建
  server
    {
      listen 80;
      server_name frps.tool.budblack.me;
      location / {
        proxy_redirect off;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header Host $http_host;
        proxy_pass http://10.80.232.165:9042;
        # auth_basic "EI PSY CONGROO.";
        # auth_basic_user_file /etc/nginx/htpasswd; 
      }
    }
  
  # FRPS 大渡河代理服务
  server
    {
      listen 9576;
      server_name frps.tool.budblack.me;
      location / {
        proxy_redirect off;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header Host $http_host;
        proxy_pass http://10.80.232.165:9575;
        auth_basic "EI PSY CONGROO.";
        auth_basic_user_file /etc/nginx/htpasswd; 
      }
    }
  
  # RabbbitMQ 管理面板
  server
    {
      listen 80;
      server_name mq.tool.budblack.me;
      location / {
        proxy_redirect off;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header Host $http_host;
        proxy_pass http://10.80.232.165:9584;
        #auth_basic "EI PSY CONGROO.";
        #auth_basic_user_file /etc/nginx/htpasswd; 
      }
    }
  
  # socketio 2018年01月26日21:49:07 部署
  map $http_upgrade $connection_upgrade {
      default upgrade;
      '' close;
  }
  upstream websocket {
      server 10.80.232.165:9550;
  }
  server {
      listen 80;
      server_name io.tool.budblack.me;
      location / {
          proxy_pass http://websocket;
          proxy_http_version 1.1;
          proxy_set_header Upgrade $http_upgrade;
          proxy_set_header Connection $connection_upgrade;
      }
  }
  server
  {
    listen              443 ssl;
    server_name         io.tool.budblack.me;
    ssl_certificate     /etc/nginx/io.tool.budblack.me.crt;
    ssl_certificate_key /etc/nginx/io.tool.budblack.me.key;
    ssl_protocols       TLSv1 TLSv1.1 TLSv1.2;
    ssl_ciphers         HIGH:!aNULL:!MD5;
    location / {
      proxy_pass http://websocket;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade; 
    }
  }
  
  # 一点同学后端代理 2018年2月20日11:13:59
  upstream ydtx {
      server 10.80.232.165:9001;
  }
  server {
    listen 80;
    server_name ydtx.budblack.me;
    location / {
        proxy_pass http://ydtx;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;
    }
  }

  # google fonts proxy  
  server {
    listen 80;
    listen [::]:80;
    server_name fonts.tool.budblack.me;
    location /css {
        sub_filter 'fonts.gstatic.com' 'fonts.msign.net';
        sub_filter_once off;
        sub_filter_types text/css;
        proxy_pass_header Server;
        proxy_set_header Host fonts.loli.net;
        proxy_set_header Accept-Encoding '';
        proxy_redirect off;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Scheme $scheme;
        proxy_pass http://fonts.loli.net:80;
    }
    location / {
        proxy_pass_header Server;
        proxy_set_header Host gstatic.loli.net;
        proxy_redirect off;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Scheme $scheme;
        proxy_pass http://gstatic.loli.net:80;
    }
  }
  
  # CalibreWeb
  server {
      listen 80;
      server_name calibre.tool.budblack.me;
      location / {
        proxy_http_version 1.1;
        proxy_set_header Host $http_host;
        proxy_pass http://10.80.232.165:8083;
      }
  }
  
  # blog
  server {
      listen 80;
      server_name www.budblack.me budblack.me www.msign.net msign.net;
      location / {
        proxy_http_version 1.1;
        proxy_set_header Host $http_host;
        proxy_pass http://10.80.232.165:9047;
      }
  }
  server
  {
    listen              443 ssl;
    server_name         www.budblack.me budblack.me www.msign.net msign.net;
    ssl_certificate     /etc/nginx/budblack.me.crt;
    ssl_certificate_key /etc/nginx/budblack.me.key;
    ssl_protocols       TLSv1 TLSv1.1 TLSv1.2;
    ssl_ciphers         HIGH:!aNULL:!MD5;
    location / {
        proxy_http_version 1.1;
        proxy_set_header Host $http_host;
        proxy_pass http://10.80.232.165:9047;
    }
  }

  # sjk.atech.ltd
  server {
      listen 80;
      server_name sjk.alpha.budblack.me;
      location / {
        proxy_http_version 1.1;
        proxy_set_header Host $http_host;
        proxy_pass http://10.80.232.165:9114;
      }
  }

  # 物联网设备定位数据接受 2018-05-24 14:43:59
  server {
      listen 80;
      server_name ws.msign.net;
      location / {
          proxy_pass http://10.80.232.165:9100;
          proxy_http_version 1.1;
          proxy_set_header Upgrade $http_upgrade;
          proxy_set_header Connection $connection_upgrade;
      }
  }
  server {
      listen 80;
      server_name ab.msign.net;
      location / {
          proxy_pass http://10.80.232.165:9101;
          proxy_http_version 1.1;
          proxy_set_header Upgrade $http_upgrade;
          proxy_set_header Connection $connection_upgrade;
      }
  }
  
  # 唱学堂 2018年06月25日14:16:42 启动
  server {
      listen 80;
      server_name chxt.ot.budblack.me;
      location / {
          proxy_pass http://10.80.232.165:9539;
          proxy_http_version 1.1;
          proxy_set_header Upgrade $http_upgrade;
          proxy_set_header Connection $connection_upgrade;
      }
  }
  
  # 安徽蛋糕 demo 2018-10-25 12:09:50 部署
  server {
      listen 80;
      server_name anhuicake.api.o.budblack.me;
      location / {
          proxy_pass http://10.80.232.165:7401;
          proxy_http_version 1.1;
          proxy_set_header Upgrade $http_upgrade;
          proxy_set_header Connection $connection_upgrade;
      }
  }
  
  # 一点同学 2018年08月23日21:34:50 新架构
  # 骑手
  server {
      listen 80;
      server_name one-classmate.ot.budblack.me;
      location / {
          proxy_pass http://10.80.232.165:9777;
          proxy_http_version 1.1;
          proxy_set_header Upgrade $http_upgrade;
          proxy_set_header Connection $connection_upgrade;
      }
  }
  # 公众号
  server {
      listen 80;
      server_name one-classmate-user.ot.budblack.me;
      location / {
          proxy_pass http://10.80.232.165:9778;
          proxy_http_version 1.1;
          proxy_set_header Upgrade $http_upgrade;
          proxy_set_header Connection $connection_upgrade;
      }
  }
  # SPA Admin
  server {
      listen 80;
      server_name one-classmate-spa-admin.ot.budblack.me;
      location / {
          proxy_pass http://10.80.232.165:9771;
          proxy_http_version 1.1;
          proxy_set_header Upgrade $http_upgrade;
          proxy_set_header Connection $connection_upgrade;
      }
  }
  # SPA Agent
  server {
      listen 80;
      server_name one-classmate-spa-agent.ot.budblack.me;
      location / {
          proxy_pass http://10.80.232.165:9772;
          proxy_http_version 1.1;
          proxy_set_header Upgrade $http_upgrade;
          proxy_set_header Connection $connection_upgrade;
      }
  }
  # SPA Client
  server {
      listen 80;
      server_name one-classmate-spa-client.ot.budblack.me;
      location / {
          proxy_pass http://10.80.232.165:9773;
          proxy_http_version 1.1;
          proxy_set_header Upgrade $http_upgrade;
          proxy_set_header Connection $connection_upgrade;
      }
  }
  # SPA Service
  server {
      listen 80;
      server_name one-classmate-spa-service.ot.budblack.me;
      location / {
          proxy_pass http://10.80.232.165:9774;
          proxy_http_version 1.1;
          proxy_set_header Upgrade $http_upgrade;
          proxy_set_header Connection $connection_upgrade;
      }
  }
  # SPA Rider
  server {
      listen 80;
      server_name one-classmate-spa-rider.ot.budblack.me;
      location / {
          proxy_pass http://10.80.232.165:9775;
          proxy_http_version 1.1;
          proxy_set_header Upgrade $http_upgrade;
          proxy_set_header Connection $connection_upgrade;
      }
  }
   # jenkins
  server {
      listen 80;
      server_name jenkins.tool.budblack.me;
      client_max_body_size    1000m;
      location / {
          proxy_pass http://10.80.232.165:9632;
          proxy_http_version 1.1;
          proxy_set_header Upgrade           $http_upgrade;
          proxy_set_header Connection        $connection_upgrade;
          proxy_set_header Host              $host;
          proxy_set_header X-Real-IP         $remote_addr;
          proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
          proxy_set_header X-Forwarded-Proto $scheme;
      }
  }
}
